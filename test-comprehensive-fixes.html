<!DOCTYPE html>
<html>
<head>
    <title>🔧 Test All Email System Fixes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 15px 0; border-radius: 8px; border: 1px solid #e9ecef; }
        .step { background: white; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; border-radius: 4px; }
        .expected { background: #d1edff; border-left: 4px solid #0066cc; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .error { background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 10px 0; border-radius: 4px; }
        code { background: #f8f9fa; padding: 3px 6px; border-radius: 3px; font-family: 'Courier New', monospace; font-size: 0.9em; }
        .priority { background: #e7f3ff; border: 2px solid #007bff; }
        h2 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .checklist { list-style: none; padding: 0; }
        .checklist li { padding: 8px 0; border-bottom: 1px solid #eee; }
        .emoji { font-size: 1.2em; margin-right: 8px; }
    </style>
</head>
<body>
    <h1>🔧 Complete Email System Verification Guide</h1>
    <p><strong>Testing all three critical fixes:</strong></p>
    <ul>
        <li>✅ <strong>Fix 1:</strong> Unread count accuracy</li>
        <li>✅ <strong>Fix 2:</strong> Email click status changes + visual updates</li>
        <li>✅ <strong>Fix 3:</strong> Gmail sync integration</li>
        <li>🎨 <strong>BONUS:</strong> Restored real-time background color updates</li>
    </ul>

    <div class="test-section priority">
        <h2>🚀 Quick Setup</h2>
        <div class="step">
            <strong>1. Open Ainbox:</strong> <a href="http://localhost:5177" target="_blank">http://localhost:5177</a>
        </div>
        <div class="step">
            <strong>2. Open Dev Tools:</strong> Press <code>F12</code> → Console tab → Clear console (🗑️)
        </div>
        <div class="step">
            <strong>3. Login and navigate to Inbox</strong>
        </div>
        <div class="step">
            <strong>4. Keep server terminal visible</strong> for backend logs
        </div>
    </div>

    <div class="test-section">
        <h2>📊 Test 1: Unread Count Accuracy</h2>

        <div class="step">
            <strong>🎯 What to Test:</strong> Verify unread count matches actual unread emails
        </div>

        <div class="step">
            <strong>📝 Actions:</strong>
            <ol>
                <li>Load the inbox and wait for emails to appear</li>
                <li>Count the bold/unread emails in the list manually</li>
                <li>Compare with the sidebar unread count number</li>
            </ol>
        </div>

        <div class="expected">
            <strong>✅ Expected Console Logs:</strong><br>
            <code>✅ Count validation PASSED: X unread emails</code><br>
            <code>📊 Current unread count: X</code>
        </div>

        <div class="error">
            <strong>🚨 RED FLAGS:</strong><br>
            <code>❌ COUNT MISMATCH DETECTED!</code><br>
            <code>Expected: X, Got: Y</code>
        </div>
    </div>

    <div class="test-section">
        <h2>🖱️ Test 2: Email Click + Real-Time Updates</h2>

        <div class="step">
            <strong>🎯 What to Test:</strong> Click unread email → immediate visual change + count update
        </div>

        <div class="step">
            <strong>📝 Actions:</strong>
            <ol>
                <li>Find an <strong>unread email</strong> (bold text, different background)</li>
                <li>Note the current unread count</li>
                <li><strong>Click the email</strong></li>
                <li>Watch for immediate changes</li>
            </ol>
        </div>

        <div class="expected">
            <strong>✅ Expected Results:</strong>
            <ul>
                <li><strong>Immediate Visual:</strong> Email row changes from bold to normal text</li>
                <li><strong>Background Color:</strong> Email background updates immediately</li>
                <li><strong>Count Update:</strong> Sidebar unread count decreases by 1</li>
                <li><strong>Thread View:</strong> Email opens in thread view</li>
            </ul>
        </div>

        <div class="expected">
            <strong>✅ Expected Console Logs:</strong><br>
            <code>📧 Email selected: [MESSAGE_ID], Current isRead: false</code><br>
            <code>📧 Converting message ID [MESSAGE_ID] to thread ID [THREAD_ID]</code><br>
            <code>📧 Frontend: Marking 1 email(s) as read: [THREAD_ID]</code><br>
            <code>📧 Updated unread count from X to Y</code><br>
            <code>📊 Skipping backend count update - optimistic update already applied</code>
        </div>

        <div class="error">
            <strong>🚨 RED FLAGS:</strong><br>
            <code>❌ Failed to mark email as read</code><br>
            <code>❌ COUNT MISMATCH DETECTED!</code><br>
            Email doesn't change appearance immediately
        </div>
    </div>

    <div class="test-section">
        <h2>🔄 Test 3: Gmail Backend Sync</h2>

        <div class="step">
            <strong>🎯 What to Test:</strong> App changes sync to Gmail servers
        </div>

        <div class="step">
            <strong>📝 Actions:</strong>
            <ol>
                <li>After clicking an email in Test 2</li>
                <li>Check your server terminal logs</li>
                <li>Open <a href="https://mail.google.com" target="_blank">Gmail web</a> in another tab</li>
                <li>Verify the same email is marked as read there</li>
            </ol>
        </div>

        <div class="expected">
            <strong>✅ Expected Server Logs:</strong><br>
            <code>📧 Gmail mark-read request received for 1 email(s): [THREAD_ID]</code><br>
            <code>🔄 Syncing read state to Gmail for thread [THREAD_ID]</code><br>
            <code>✅ Successfully synced read state to Gmail for thread [THREAD_ID]</code><br>
            <code>📧 Socket.IO emission: emailUpdated for user [USER_ID]</code>
        </div>

        <div class="success">
            <strong>🎉 Gmail Web Verification:</strong> The email should show as read (not bold) in Gmail web interface
        </div>

        <div class="error">
            <strong>🚨 RED FLAGS:</strong><br>
            <code>❌ Failed to sync read state</code><br>
            <code>GaxiosError: Requested entity was not found</code><br>
            Email still appears unread in Gmail web
        </div>
    </div>

    <div class="test-section">
        <h2>🎨 Test 4: Real-Time Color Updates (CRITICAL)</h2>

        <div class="step">
            <strong>🎯 What to Test:</strong> Background colors update immediately via Socket.IO
        </div>

        <div class="step">
            <strong>📝 Actions:</strong>
            <ol>
                <li>Click an unread email</li>
                <li>Watch the email row background change instantly</li>
                <li>Go back to email list (if in thread view)</li>
                <li>Verify the email row now has "read" styling</li>
            </ol>
        </div>

        <div class="expected">
            <strong>✅ Expected Visual Changes:</strong>
            <ul>
                <li>Email row background color changes immediately</li>
                <li>Text changes from bold to normal weight</li>
                <li>No page refresh needed</li>
                <li>Changes persist when navigating back to list</li>
            </ul>
        </div>

        <div class="expected">
            <strong>✅ Expected Console Logs:</strong><br>
            <code>📧 Socket.IO emailUpdated received</code><br>
            <code>📧 Processing email update for ID: [MESSAGE_ID]</code><br>
            <code>📧 Email found and updated: isRead = true</code>
        </div>

        <div class="warning">
            <strong>⚠️ This was BROKEN before - verify it's working again!</strong><br>
            If colors don't update immediately, the Socket.IO event matching is still broken.
        </div>
    </div>

    <div class="test-section">
        <h2>🔍 Advanced Testing Scenarios</h2>

        <div class="step">
            <strong>Multi-Email Test:</strong>
            <ol>
                <li>Select multiple unread emails using checkboxes</li>
                <li>Use "Mark as Read" bulk action</li>
                <li>Verify all selected emails change status</li>
                <li>Check unread count decreases by correct amount</li>
            </ol>
        </div>

        <div class="step">
            <strong>External Change Test:</strong>
            <ol>
                <li>Open Gmail web in another tab</li>
                <li>Mark an email as read/unread there</li>
                <li>Watch for real-time updates in your Ainbox app</li>
                <li>Should see Socket.IO updates in console</li>
            </ol>
        </div>

        <div class="step">
            <strong>Page Navigation Test:</strong>
            <ol>
                <li>Make changes on page 1</li>
                <li>Navigate to page 2 and back</li>
                <li>Verify changes persist</li>
                <li>Check count accuracy across pages</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>🚨 Troubleshooting Guide</h2>

        <h3>Count Issues:</h3>
        <div class="warning">
            <strong>If counts don't match:</strong>
            <ul>
                <li>Look for <code>COUNT MISMATCH DETECTED!</code> messages</li>
                <li>Check if multiple count updates are happening</li>
                <li>Verify <code>optimistic update already applied</code> messages</li>
                <li>Refresh page and retest</li>
            </ul>
        </div>

        <h3>Visual Update Issues:</h3>
        <div class="warning">
            <strong>If colors don't change immediately:</strong>
            <ul>
                <li>Check for Socket.IO connection errors</li>
                <li>Look for <code>emailUpdated received</code> logs</li>
                <li>Verify message ID matching in console</li>
                <li>Check server terminal for Socket.IO emissions</li>
            </ul>
        </div>

        <h3>Gmail Sync Issues:</h3>
        <div class="warning">
            <strong>If Gmail doesn't sync:</strong>
            <ul>
                <li>Check server logs for API errors</li>
                <li>Look for 404 "entity not found" errors</li>
                <li>Verify authentication tokens</li>
                <li>Check thread ID conversion logs</li>
            </ul>
        </div>
    </div>

    <div class="test-section success">
        <h2>📋 Final Verification Checklist</h2>
        <ul class="checklist">
            <li>☐ <span class="emoji">📊</span> <strong>Count Accuracy:</strong> Sidebar count matches actual unread emails</li>
            <li>☐ <span class="emoji">🖱️</span> <strong>Click Response:</strong> Emails change status when clicked</li>
            <li>☐ <span class="emoji">🎨</span> <strong>Visual Updates:</strong> Background colors change immediately</li>
            <li>☐ <span class="emoji">📝</span> <strong>Text Changes:</strong> Bold text becomes normal when read</li>
            <li>☐ <span class="emoji">🔢</span> <strong>Count Updates:</strong> Unread count decreases correctly</li>
            <li>☐ <span class="emoji">🔄</span> <strong>Gmail Sync:</strong> Changes appear in Gmail web</li>
            <li>☐ <span class="emoji">📡</span> <strong>Real-Time:</strong> Socket.IO events working</li>
            <li>☐ <span class="emoji">❌</span> <strong>No Errors:</strong> No console errors or 404s</li>
        </ul>

        <div style="background: #28a745; color: white; padding: 15px; border-radius: 5px; margin-top: 20px; text-align: center;">
            <strong>🎉 SUCCESS: All boxes checked = All three fixes working perfectly!</strong>
        </div>
    </div>

    <div class="test-section">
        <h2>📞 If Issues Persist</h2>
        <div class="step">
            <strong>Report with these details:</strong>
            <ul>
                <li>Which specific test failed</li>
                <li>Console error messages (copy exact text)</li>
                <li>Server log errors</li>
                <li>What you expected vs what happened</li>
                <li>Screenshot of the issue</li>
            </ul>
        </div>
    </div>
</body>
</html>